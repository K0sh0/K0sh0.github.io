<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Street View Globe Guessing Game ‚Äî Ports Mode (15 miles, Map Toggle + Leaderboard + Initials Modal)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1220;
      --panel:#151935;
      --accent:#7dd3fc;
      --text:#e5e7eb;
      --muted:#9aa3b2;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --glass:rgba(21,25,53,.7);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 70% 20%,#1a2045 0%,#0b0e1a 60%,#070913 100%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #app{position:relative;height:100%;width:100%}
    #pano{position:absolute;inset:0;border:none}
    /* HUD */
    .hud{
      position:absolute;left:16px;top:16px;z-index:5;
      display:flex;gap:10px;align-items:center;
      background:var(--glass);backdrop-filter: blur(8px);
      border:1px solid rgba(125,211,252,.25);
      border-radius:16px;padding:10px 14px;box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    .chip{display:flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#0f1330;border:1px solid rgba(255,255,255,.08);color:var(--text);font-weight:600;font-size:14px}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.green{background:var(--good)} .dot.yellow{background:var(--warn)}
    .chip .label{opacity:.8;font-weight:500}
    /* Globe map (mini) */
    #globeWrap{
      position:absolute;right:16px;bottom:16px;z-index:6;
      width:360px;height:260px;border-radius:18px;overflow:hidden;
      box-shadow:0 14px 40px rgba(0,0,0,.5);border:1px solid rgba(125,211,252,.25);
      background:var(--panel)
    }
    #globe{width:100%;height:100%}
    #globeHeader{
      position:absolute;left:10px;top:10px;z-index:7;
      padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.45);color:#cfe9ff;border:1px solid rgba(255,255,255,.08);font-size:12px
    }
    /* Toggle button ‚Äî OVER the map (overlay) */
    #toggleMapBtn{
      position:absolute;right:24px;bottom:24px;z-index:8;
      appearance:none;border:none;cursor:pointer;
      padding:10px 12px;border-radius:999px;font-weight:800;
      color:#0b1020;background:var(--accent);transition:.2s transform, .2s opacity;
      border:1px solid rgba(125,211,252,.3);
      box-shadow:0 10px 30px rgba(0,0,0,.45)
    }
    #toggleMapBtn:hover{transform:translateY(-2px)}
    .mapHidden #toggleMapBtn{position:absolute;right:16px;bottom:16px;z-index:8;}
    /* Controls */
    .controls{
      position:absolute;left:50%;transform:translateX(-50%);
      bottom:16px;z-index:7;display:flex;gap:10px;align-items:center;
      background:var(--glass);backdrop-filter: blur(10px);
      border:1px solid rgba(125,211,252,.25);border-radius:16px;padding:10px 12px;
      box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    button{
      appearance:none;border:none;cursor:pointer;
      padding:10px 14px;border-radius:10px;font-weight:700;
      color:#0b1020;background:var(--accent);transition:.2s transform, .2s opacity
    }
    button:hover{transform:translateY(-1px)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .secondary{background:#22274f;color:#e5e7eb;border:1px solid rgba(255,255,255,.08)}
    .hint{font-size:13px;color:var(--muted);padding:0 8px}
    /* Result overlay */
    #result{
      position:absolute;inset:0;z-index:8;display:none;
      background:rgba(3,6,18,.65);backdrop-filter:blur(6px)
    }
    #resultCard{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:min(92vw,960px);height:min(80vh,580px);background:var(--panel);
      border:1px solid rgba(125,211,252,.25);border-radius:18px;overflow:hidden;
      box-shadow:0 30px 80px rgba(0,0,0,.6)
    }
    #resultMap{width:100%;height:70%}
    #resultInfo{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 16px;border-top:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(17,23,50,.85),rgba(17,23,50,.65))
    }
    .scoreLine{display:flex;gap:14px;align-items:baseline}
    .scoreBig{font-size:28px;font-weight:900}
    .distance{font-size:14px;color:#cfe9ff;opacity:.9}
    .rounds{font-size:12px;color:var(--muted)}
    .pill{padding:6px 10px;border-radius:999px;background:#0f1330;border:1px solid rgba(255,255,255,.08);color:#bfe7ff;font-weight:600}
    .footerHelp{
      position:absolute;right:16px;top:16px;z-index:5;font-size:12px;color:#b9c3d6;opacity:.9
    }
    /* Leaderboard card */
    #leaderboard{
      position:absolute;left:16px;bottom:16px;z-index:9;
      padding:12px 14px;border-radius:14px;background:rgba(6,10,28,.6);
      border:1px solid rgba(255,255,255,.1);backdrop-filter:blur(8px);
      min-width:260px;max-width:320px;
      box-shadow:0 14px 40px rgba(0,0,0,.45)
    }
    #leaderboard h3{margin:0 0 8px 0;font-size:14px;letter-spacing:.3px}
    #boardList{font-size:13px;line-height:1.5}
    .row{display:flex;justify-content:space-between;padding:2px 0}
    .me{color:#bfe7ff}
    .small{font-size:12px;color:#9fb1c9;margin-top:6px}

    /* ===== Initials Modal ===== */
    #initialsModal{
      position:fixed;inset:0;z-index:20;display:none;
      align-items:center;justify-content:center;
      background:rgba(3,6,18,.6);backdrop-filter: blur(4px);
    }
    #initialsCard{
      width:min(92vw,520px);
      background:var(--panel);
      border:1px solid rgba(125,211,252,.25);
      border-radius:18px;overflow:hidden;
      box-shadow:0 30px 80px rgba(0,0,0,.6)
    }
    #initialsHead{
      padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;justify-content:space-between;align-items:center
    }
    #initialsHead h4{margin:0;font-size:16px}
    #initialsClose{
      background:transparent;color:#cfe9ff;border:1px solid rgba(255,255,255,.12);
      border-radius:10px;padding:6px 10px;cursor:pointer
    }
    #initialsBody{padding:14px 16px}
    .slots{display:flex;gap:10px;justify-content:center;margin-bottom:12px}
    .slot{
      width:56px;height:64px;border-radius:12px;border:1px solid rgba(255,255,255,.16);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:28px;background:#0f1330;color:#cfe9ff;
      box-shadow: inset 0 -4px 0 rgba(255,255,255,.04);
    }
    #keypad{
      display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-top:8px
    }
    .key{
      padding:10px 0;border-radius:10px;text-align:center;cursor:pointer;
      background:#1a2045;border:1px solid rgba(255,255,255,.1);user-select:none
    }
    .key:hover{transform:translateY(-1px)}
    .key.wide{grid-column:span 2}
    .actions{display:flex;justify-content:space-between;gap:10px;margin-top:12px}
    .btn{
      padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
      background:var(--accent);color:#0b1020;font-weight:800;cursor:pointer;flex:1
    }
    .btn.secondary{background:#22274f;color:#e5e7eb}
    .msg{margin-top:8px;font-size:12px;color:#9fb1c9;text-align:center}
    @media (max-width:720px){
      #globeWrap{width:75vw;height:38vh}
      .controls{left:auto;right:16px;transform:none}
      #toggleMapBtn{right:16px;bottom:16px}
      #leaderboard{left:16px;right:auto;bottom:16px}
      .slot{width:48px;height:56px;font-size:24px}
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="pano"></div>

    <div class="hud" id="hud">
      <div class="chip"><span class="dot green"></span><span class="label">Round</span> <span id="roundNow">1</span>/ <span id="roundMax">5</span></div>
      <div class="chip"><span class="dot yellow"></span><span class="label">Total</span> <span id="totalScore">0</span> pts</div>
    </div>

    <!-- Mini-map wrapper -->
    <div id="globeWrap">
      <div id="globeHeader">Click the globe to place your guess</div>
      <div id="globe"></div>
    </div>
    <!-- Toggle button OVER the map -->
    <button id="toggleMapBtn" aria-pressed="false" aria-controls="globeWrap" title="Hide mini map">Hide Map</button>

    <!-- Leaderboard -->
    <div id="leaderboard">
      <h3>üèÜ Leaderboard (Top 10)</h3>
      <div id="boardList">Loading‚Ä¶</div>
      <div class="small">Enter your initials after the game (A‚ÄìZ/0‚Äì9).</div>
    </div>

    <!-- Initials Modal -->
    <div id="initialsModal" role="dialog" aria-modal="true" aria-labelledby="initialsTitle">
      <div id="initialsCard">
        <div id="initialsHead">
          <h4 id="initialsTitle">Submit Score</h4>
          <button id="initialsClose">Cancel</button>
        </div>
        <div id="initialsBody">
          <div class="slots">
            <div class="slot" id="slot0">‚Ä¢</div>
            <div class="slot" id="slot1">‚Ä¢</div>
            <div class="slot" id="slot2">‚Ä¢</div>
          </div>
          <div id="keypad"></div>
          <div class="actions">
            <button class="btn secondary" id="btnClear">Clear</button>
            <button class="btn" id="btnSubmit" disabled>Submit</button>
          </div>
          <div class="msg" id="initialsMsg"></div>
        </div>
      </div>
    </div>

    <div class="footerHelp">Tip: You can move around in Street View before guessing.</div>

    <div class="controls">
      <span class="hint" id="status">Loading a random location‚Ä¶</span>
      <button id="btnGuess" disabled>Guess</button>
      <button id="btnSkip" class="secondary">Skip</button>
      <button id="btnNew" class="secondary" style="display:none">New Game</button>
    </div>

    <!-- Result overlay -->
    <div id="result">
      <div id="resultCard">
        <div id="resultMap"></div>
        <div id="resultInfo">
          <div class="scoreLine">
            <span class="pill" id="distanceText">‚Äî</span>
            <span class="scoreBig" id="scoreThisRound">0</span><span>pts</span>
            <span class="rounds" id="roundSummary"></span>
          </div>
          <div>
            <button id="btnNext">Next Round</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Google Maps JS (Street View + Maps). Your API key is embedded per your request. -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIujmdEMh04_ZfJB1kZ0839Fh_MI8pQAU&v=weekly&callback=initGame">
  </script>

  <script>
    /* ======= Game State ======= */
    let pano, svService, guessMap, resultMap, guessMarker, actualMarker, linkLine;
    let currentActualLatLng = null;
    let currentGuessLatLng = null;
    let totalScore = 0;
    let roundNow = 1;
    const roundMax = 5;
    let loadingNew = false;
    let miniMapVisible = true;

    /* ======= Supabase (fill these with your project details) ======= */
    const SUPABASE_URL = "https://ckajnizstineqlvwmelc.supabase.co"; // <-- replace
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrYWpuaXpzdGluZXFsdndtZWxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU0NzY3OTUsImV4cCI6MjA3MTA1Mjc5NX0.UbexwbgzhICpCw5tUlwKH-sRvx6aFBWXOBFYbycbUKw";                // <-- replace (anon public)
    const TOP_LIMIT = 5;
    const NAME_LEN = 3;

    async function sbFetch(path, init={}){
      const headers = {
        "apikey": SUPABASE_KEY,
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/json",
        ...init.headers
      };
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, { ...init, headers });
      if(!res.ok){
        const t = await res.text().catch(()=> "error");
        throw new Error(t);
      }
      return res.json();
    }
    async function saveScore(name, points){
      name = sanitizeName(name);
      if (name.length !== NAME_LEN) throw new Error("Name must be exactly 3 characters.");
      const safePoints = Math.max(0, Math.round(points||0));
      return sbFetch("scores", { method:"POST", body: JSON.stringify([{ name, points: safePoints }]) });
    }
    function sanitizeName(s){
      return (s||"").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0, NAME_LEN);
    }
    async function getTopScores(limit=TOP_LIMIT){
      const params = new URLSearchParams({
        select:"*",
        order:"points.desc,created_at.desc",
        limit:String(limit)
      }).toString();
      return sbFetch(`scores?${params}`);
    }
    function renderLeaderboard(list, highlightName = null){
      const el = document.getElementById("boardList");
      if(!Array.isArray(list) || list.length===0){
        el.innerHTML = "<div class='small'>No scores yet. Be the first!</div>";
        return;
      }
      el.innerHTML = list.map((r,i)=>{
        const you = highlightName && r.name === highlightName ? " me" : "";
        const safeName = escapeHtml(r.name || "‚Äî");
        return `<div class="row${you}"><span>${i+1}. ${safeName}</span><b>${r.points}</b></div>`;
      }).join("");
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }
    async function refreshLeaderboard(highlightName=null){
      try{
        const list = await getTopScores(TOP_LIMIT);
        renderLeaderboard(list, highlightName);
      }catch(e){
        console.error("Leaderboard load failed", e);
        document.getElementById("boardList").textContent = "Leaderboard unavailable.";
      }
    }

    /* ======= Initials Modal Logic ======= */
    let modalOpen = false;
    let initials = ["","",""];
    let focusIndex = 0;
    let onSubmitCallback = null;
    let onCancelCallback = null;

    function updateSlots(){
      for(let i=0;i<3;i++){
        const el = document.getElementById("slot"+i);
        el.textContent = initials[i] || "‚Ä¢";
      }
      document.getElementById("btnSubmit").disabled = initials.join("").length !== 3;
    }

    function openInitialsModal(defaultValue=""){
      initials = sanitizeName(defaultValue || localStorage.getItem("playerName3") || "").split("");
      while(initials.length<3) initials.push("");
      focusIndex = initials.findIndex(ch => ch==="");
      if (focusIndex === -1) focusIndex = 2;
      updateSlots();
      document.getElementById("initialsMsg").textContent = "";
      document.getElementById("initialsModal").style.display = "flex";
      modalOpen = true;
    }
    function closeInitialsModal(){
      document.getElementById("initialsModal").style.display = "none";
      modalOpen = false;
    }

    function appendChar(ch){
      ch = sanitizeName(ch);
      if(!ch) return;
      for(let i=0;i<3;i++){
        if(!initials[i]){ initials[i]=ch; break; }
      }
      updateSlots();
    }
    function backspace(){
      for(let i=2;i>=0;i--){
        if(initials[i]){ initials[i]=""; break; }
      }
      updateSlots();
    }
    function clearInitials(){
      initials = ["","",""];
      updateSlots();
    }

    function buildKeypad(){
      const keys = [];
      // A-Z then 0-9
      for(let i=65;i<=90;i++) keys.push(String.fromCharCode(i));
      for(let i=48;i<=57;i++) keys.push(String.fromCharCode(i));
      const pad = document.getElementById("keypad");
      pad.innerHTML = "";
      keys.forEach(k=>{
        const b = document.createElement("div");
        b.className = "key";
        b.textContent = k;
        b.addEventListener("click", ()=>appendChar(k));
        pad.appendChild(b);
      });
      // special keys
      const bk = document.createElement("div");
      bk.className="key wide";
      bk.textContent="‚å´ Back";
      bk.addEventListener("click", backspace);
      pad.appendChild(bk);

      const sp = document.createElement("div");
      sp.className="key wide";
      sp.textContent="‚ü≤ Clear";
      sp.addEventListener("click", clearInitials);
      pad.appendChild(sp);
    }

    function submitInitials(){
      const name = initials.join("");
      if(name.length!==3){
        document.getElementById("initialsMsg").textContent = "Please enter exactly 3 characters.";
        return;
      }
      localStorage.setItem("playerName3", name);
      closeInitialsModal();
      if (typeof onSubmitCallback === "function") onSubmitCallback(name);
    }

    function initInitialsUI(){
      buildKeypad();
      document.getElementById("btnClear").addEventListener("click", clearInitials);
      document.getElementById("btnSubmit").addEventListener("click", submitInitials);
      document.getElementById("initialsClose").addEventListener("click", ()=>{
        closeInitialsModal();
        if (typeof onCancelCallback === "function") onCancelCallback();
      });
      // Basic keyboard support
      window.addEventListener("keydown", (e)=>{
        if(!modalOpen) return;
        if(e.key==="Escape"){ closeInitialsModal(); if(onCancelCallback) onCancelCallback(); }
        else if(e.key==="Backspace"){ backspace(); e.preventDefault(); }
        else if(/^[a-zA-Z0-9]$/.test(e.key)){ appendChar(e.key); }
        else if(e.key==="Enter"){ if(initials.join("").length===3) submitInitials(); }
      });
    }

    function askForInitials(){
      return new Promise((resolve,reject)=>{
        onSubmitCallback = (name)=> resolve(name);
        onCancelCallback = ()=> reject(new Error("cancelled"));
        openInitialsModal();
      });
    }

    /* ======= Ports (provided list) ======= */
    const PORTS = [
      {name:'Acapulco, Mexico', lng:-99.8815, lat:16.8636},
      {name:'√Ölesund, Norway', lng:6.1549, lat:62.4722},
      {name:'Amsterdam, Netherlands', lng:4.9041, lat:52.3676},
      {name:'Ashdod, Israel', lng:34.6435, lat:31.8014},
      {name:'Astoria, Oregon', lng:-123.8313, lat:46.1879},
      {name:'Athens/Piraeus, Greece', lng:23.6460, lat:37.9420},
      {name:'Barcelona, Spain', lng:2.1686, lat:41.3874},
      {name:'Bar Harbor, Maine', lng:-68.2039, lat:44.3876},
      {name:'Basseterre, St. Kitts', lng:-62.7177, lat:17.3026},
      {name:'Belize City, Belize', lng:-88.1962, lat:17.5046},
      {name:'Bergen, Norway', lng:5.3221, lat:60.3913},
      {name:'Boston, Massachusetts', lng:-71.0589, lat:42.3601},
      {name:'Bridgetown, Barbados', lng:-59.6167, lat:13.0975},
      {name:'Brisbane, Australia', lng:153.0251, lat:-27.4698},
      {name:'Cabo San Lucas, Mexico', lng:-109.9167, lat:22.8905},
      {name:'Cairns, Australia', lng:145.7703, lat:-16.9203},
      {name:'Cam Ranh, Vietnam', lng:109.2207, lat:11.9020},
      {name:'Cannes, France', lng:7.0174, lat:43.5528},
      {name:'Cartagena, Colombia', lng:-75.4794, lat:10.3910},
      {name:'Castries, St. Lucia', lng:-60.9875, lat:14.0101},
      {name:'Charlottetown, Prince Edward Island', lng:-63.1311, lat:46.2382},
      {name:'Charlotte Amalie, St. Thomas (USVI)', lng:-64.9320, lat:18.3419},
      {name:'Copenhagen, Denmark', lng:12.5683, lat:55.6761},
      {name:'Corfu, Greece', lng:19.9217, lat:39.6243},
      {name:'Costa Maya (Mahahual), Mexico', lng:-87.7090, lat:18.7130},
      {name:'Cozumel, Mexico', lng:-86.9223, lat:20.4220},
      {name:'Dublin, Ireland', lng:-6.2603, lat:53.3498},
      {name:'Dubrovnik, Croatia', lng:18.0944, lat:42.6507},
      {name:'Freeport (Grand Bahama), Bahamas', lng:-78.7000, lat:26.5333},
      {name:'Funchal (Madeira), Portugal', lng:-16.9241, lat:32.6669},
      {name:'Gasp√©, Qu√©bec', lng:-64.4819, lat:48.8302},
      {name:'George Town, Grand Cayman', lng:-81.3673, lat:19.2866},
      {name:'Glasgow/Greenock, Scotland', lng:-4.7693, lat:55.9563},
      {name:'Grand Turk, Turks & Caicos', lng:-71.1389, lat:21.4675},
      {name:'Great Stirrup Cay, Bahamas', lng:-77.8860, lat:25.8170},
      {name:'H·∫° Long Bay (H√≤n Gai), Vietnam', lng:107.0730, lat:20.9550},
      {name:'Hakodate, Japan', lng:140.7288, lat:41.7687},
      {name:'Halifax, Nova Scotia', lng:-63.5752, lat:44.6488},
      {name:'Harvest Caye, Belize', lng:-88.1886, lat:16.4550},
      {name:'Hilo (Hawai ªi), Hawaii', lng:-155.0818, lat:19.7077},
      {name:'Honolulu (O ªahu), Hawaii', lng:-157.8583, lat:21.3069},
      {name:'Hososhima (Hyuga), Japan', lng:131.6530, lat:32.4300},
      {name:'Huatulco, Mexico', lng:-96.1263, lat:15.7683},
      {name:'Icy Strait Point (Hoonah), Alaska', lng:-135.4430, lat:58.1364},
      {name:'Istanbul, T√ºrkiye', lng:28.9784, lat:41.0082},
      {name:'Izmir, T√ºrkiye', lng:27.1428, lat:38.4237},
      {name:'Juneau, Alaska', lng:-134.4197, lat:58.3019},
      {name:'Kahului (Maui), Hawaii', lng:-156.4729, lat:20.8893},
      {name:'Kailua-Kona (Hawai ªi), Hawaii', lng:-155.9970, lat:19.6400},
      {name:'Katakolon (Olympia), Greece', lng:21.3167, lat:37.6500},
      {name:'Ketchikan, Alaska', lng:-131.6461, lat:55.3422},
      {name:'Key West, Florida', lng:-81.7800, lat:24.5551},
      {name:'Kochi, Japan', lng:133.5311, lat:33.5597},
      {name:'La Baie (Saguenay), Qu√©bec', lng:-70.8826, lat:48.3327},
      {name:'La Digue, Seychelles', lng:55.8410, lat:-4.3570},
      {name:'Las Palmas (Gran Canaria)', lng:-15.4363, lat:28.1235},
      {name:'Lerwick (Shetland), Scotland', lng:-1.1456, lat:60.1539},
      {name:'Limassol, Cyprus', lng:33.0226, lat:34.7071},
      {name:'Lisbon, Portugal', lng:-9.1393, lat:38.7223},
      {name:'Livorno (for Florence/Pisa), Italy', lng:10.3106, lat:43.5485},
      {name:'Los Angeles, California', lng:-118.2437, lat:34.0522},
      {name:'L√ºderitz, Namibia', lng:15.1594, lat:-26.6481},
      {name:'M√°laga, Spain', lng:-4.4214, lat:36.7213},
      {name:'Marseille (Provence), France', lng:5.3698, lat:43.2965},
      {name:'Melbourne, Australia', lng:144.9631, lat:-37.8136},
      {name:'Messina (Sicily), Italy', lng:15.5540, lat:38.1938},
      {name:'Miami, Florida', lng:-80.1918, lat:25.7617},
      {name:'Mossel Bay, South Africa', lng:22.1460, lat:-34.1830},
      {name:'Mykonos, Greece', lng:25.3289, lat:37.4467},
      {name:'Nassau, Bahamas', lng:-77.3504, lat:25.0443},
      {name:'Naples, Italy', lng:14.2681, lat:40.8518},
      {name:'New Orleans, Louisiana', lng:-90.0715, lat:29.9511},
      {name:'New York, New York', lng:-74.0060, lat:40.7128},
      {name:'Newport, Rhode Island', lng:-71.3128, lat:41.4901},
      {name:'Nha Trang, Vietnam', lng:109.1967, lat:12.2388},
      {name:'Ocho Rios, Jamaica', lng:-77.1031, lat:18.4076},
      {name:'Oranjestad, Aruba', lng:-70.0347, lat:12.5211},
      {name:'Palma de Mallorca, Spain', lng:2.6502, lat:39.5696},
      {name:'Ponta Delgada (Azores), Portugal', lng:-25.6756, lat:37.7412},
      {name:'Port Canaveral (Orlando), Florida', lng:-80.6188, lat:28.4101},
      {name:'Port Elizabeth (Gqeberha), South Africa', lng:25.6022, lat:-33.9608},
      {name:'Portland, Maine', lng:-70.2568, lat:43.6591},
      {name:'Praslin, Seychelles', lng:55.7286, lat:-4.3176},
      {name:'Puerto Plata, Dominican Republic', lng:-70.6871, lat:19.7808},
      {name:'Puerto Quetzal, Guatemala', lng:-90.7883, lat:13.9213},
      {name:'Puntarenas, Costa Rica', lng:-84.8384, lat:9.9763},
      {name:'Qu√©bec City, Qu√©bec', lng:-71.2080, lat:46.8139},
      {name:'Reykjav√≠k, Iceland', lng:-21.9426, lat:64.1466},
      {name:'Richards Bay, South Africa', lng:32.0377, lat:-28.7830},
      {name:'Road Town, Tortola (BVI)', lng:-64.6185, lat:18.4286},
      {name:'Roat√°n (Coxen Hole), Honduras', lng:-86.5370, lat:16.3170},
      {name:'Rome/Civitavecchia, Italy', lng:11.7920, lat:42.0930},
      {name:'Roseau, Dominica', lng:-61.3870, lat:15.3010},
      {name:'Royal Naval Dockyard, Bermuda', lng:-64.8356, lat:32.3230},
      {name:'Saint John, New Brunswick', lng:-66.0633, lat:45.2733},
      {name:'Saint Petersburg, Russia', lng:30.3609, lat:59.9311},
      {name:'San Francisco, California', lng:-122.4194, lat:37.7749},
      {name:'San Juan, Puerto Rico', lng:-66.1057, lat:18.4655},
      {name:'Santa Cruz de Tenerife, Canary Islands', lng:-16.2518, lat:28.4636},
      {name:'Santorini (Fira), Greece', lng:25.4333, lat:36.4167},
      {name:'Seattle, Washington', lng:-122.3321, lat:47.6062},
      {name:'Skagway, Alaska', lng:-135.3139, lat:59.4583},
      {name:'Split, Croatia', lng:16.4402, lat:43.5081},
      {name:'Stockholm, Sweden', lng:18.0686, lat:59.3293},
      {name:'Sydney, Australia', lng:151.2093, lat:-33.8688},
      {name:'Sydney, Nova Scotia', lng:-60.1942, lat:46.1368},
      {name:'Tallinn, Estonia', lng:24.7536, lat:59.4370},
      {name:'Tampa, Florida', lng:-82.4572, lat:27.9506},
      {name:'T√≥rshavn, Faroe Islands', lng:-6.7900, lat:62.0079},
      {name:'Tokyo, Japan', lng:139.6503, lat:35.6762},
      {name:'Toulon, France', lng:5.9280, lat:43.1242},
      {name:'Valletta, Malta', lng:14.5146, lat:35.8989},
      {name:'Vancouver, British Columbia', lng:-123.1207, lat:49.2827},
      {name:'Venice, Italy', lng:12.3155, lat:45.4408},
      {name:'Victoria (Mah√©), Seychelles', lng:55.4550, lat:-4.6200},
      {name:'Victoria, British Columbia', lng:-123.3656, lat:48.4284},
      {name:'Warnem√ºnde (Rostock), Germany', lng:12.0860, lat:54.1760},
      {name:'Whittier, Alaska', lng:-148.6837, lat:60.7752},
      {name:'Willemstad, Cura√ßao', lng:-68.9336, lat:12.1091},
      {name:'Zeebrugge (Bruges), Belgium', lng:3.2070, lat:51.3310}
    ];

    // constants
    const EARTH_R_KM = 6371;
    const LIMIT_MI = 15;
    const LIMIT_KM = LIMIT_MI * 1.609344; // 24.14016 km
    const SEARCH_RADIUS_M = 2500; // Street View search radius around candidate point

    /* ======= Utilities ======= */
    function rand(min, max){ return Math.random()*(max-min)+min; }
    function toRad(d){ return d*Math.PI/180; }
    function toDeg(r){ return r*180/Math.PI; }
    // Haversine distance in km
    function haversineKm(a, b){
      const dLat = toRad(b.lat()-a.lat());
      const dLng = toRad(b.lng()-a.lng());
      const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
      const A = s1*s1 + Math.cos(toRad(a.lat()))*Math.cos(toRad(b.lat()))*s2*s2;
      const c = 2*Math.atan2(Math.sqrt(A), Math.sqrt(1-A));
      return EARTH_R_KM*c;
    }
    // Offset a lat/lng by distance (km) and bearing (deg)
    function offsetLatLng(lat, lng, distKm, bearingDeg){
      const Œ¥ = distKm / EARTH_R_KM;
      const Œ∏ = toRad(bearingDeg);
      const œÜ1 = toRad(lat);
      const Œª1 = toRad(lng);
      const sinœÜ1 = Math.sin(œÜ1), cosœÜ1 = Math.cos(œÜ1);
      const sinŒ¥ = Math.sin(Œ¥), cosŒ¥ = Math.cos(Œ¥);
      const sinœÜ2 = sinœÜ1 * cosŒ¥ + cosœÜ1 * sinŒ¥ * Math.cos(Œ∏);
      const œÜ2 = Math.asin(sinœÜ2);
      const y = Math.sin(Œ∏) * sinŒ¥ * cosœÜ1;
      const x = cosŒ¥ - sinœÜ1 * sinœÜ2;
      const Œª2 = Œª1 + Math.atan2(y, x);
      let lng2 = toDeg(Œª2);
      lng2 = ((lng2 + 540) % 360) - 180;
      return new google.maps.LatLng(toDeg(œÜ2), lng2);
    }
    // Random point within circle radius (uniform by area)
    function randomPointWithin(lat, lng, radiusKm){
      const r = radiusKm * Math.sqrt(Math.random());
      const bearing = rand(0, 360);
      return offsetLatLng(lat, lng, r, bearing);
    }
    // Score function
    function scoreFromDistanceKm(d){
      const s = 5000*Math.exp(-d/2000);
      return Math.max(0, Math.round(s));
    }
    function setStatus(txt){ document.getElementById('status').textContent = txt; }

    /* ======= Core Flow (restricted to within 15 miles of ports) ======= */
    async function loadRandomPano(maxTries=60){
      loadingNew = true;
      setStatus('Finding a Street View spot near a cruise port‚Ä¶');
      return new Promise((resolve, reject)=>{
        let tries = 0;
        (function attempt(){
          if (tries++ >= maxTries){ reject(new Error('No panorama found near ports.')); return; }
          const base = PORTS[Math.floor(Math.random()*PORTS.length)];
          const candidate = randomPointWithin(base.lat, base.lng, LIMIT_KM * 0.98);
          svService.getPanorama(
            { location: candidate, radius: SEARCH_RADIUS_M, preference: google.maps.StreetViewPreference.BEST, source: google.maps.StreetViewSource.OUTDOOR },
            (data, status)=>{
              if (status === google.maps.StreetViewStatus.OK && data && data.location && data.location.latLng){
                const panoLatLng = data.location.latLng;
                let within = false;
                for (const p of PORTS){
                  const d = haversineKm(new google.maps.LatLng(p.lat,p.lng), panoLatLng);
                  if (d <= LIMIT_KM){ within = true; break; }
                }
                if (within){ resolve(data); }
                else { setStatus(`Searching near ports‚Ä¶ (try ${tries}/${maxTries})`); setTimeout(attempt, 40); }
              } else {
                setStatus(`Searching near ports‚Ä¶ (try ${tries}/${maxTries})`);
                setTimeout(attempt, 40);
              }
            }
          );
        })();
      });
    }

    function showPanorama(panoData){
      const latLng = panoData.location.latLng;
      currentActualLatLng = latLng;
      pano.setPano(panoData.location.pano);
      pano.setPov({heading: 0, pitch: 0});
      pano.setVisible(true);
      pano.setOptions({ linksControl: true, panControl: true, zoomControl: true, motionTracking: false });
      setStatus('Explore, then click the globe to place your guess.');
      document.getElementById('btnGuess').disabled = !currentGuessLatLng;
      loadingNew = false;
    }

    function prepareNextRound(){
      if (guessMarker){ guessMarker.setMap(null); guessMarker = null; }
      if (actualMarker){ actualMarker.setMap(null); actualMarker = null; }
      if (linkLine){ linkLine.setMap(null); linkLine = null; }
      currentGuessLatLng = null;
      document.getElementById('btnGuess').disabled = true;
      setStatus('Loading a random location near a port‚Ä¶');
      loadRandomPano().then(showPanorama).catch(()=>{
        setStatus('Could not find a Street View near ports right now. Try again.');
      });
    }

    function revealResult(){
      if (!resultMap){
        resultMap = new google.maps.Map(document.getElementById('resultMap'), {
          zoom: 3,
          center: currentActualLatLng,
          mapTypeId: 'terrain',
          gestureHandling: 'greedy',
          disableDefaultUI: false
        });
      }
      if (actualMarker){ actualMarker.setMap(null); }
      if (guessMarker && guessMarker.getMap() === resultMap){ guessMarker.setMap(null); }

      actualMarker = new google.maps.Marker({
        position: currentActualLatLng,
        map: resultMap,
        title: 'Actual location',
        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, strokeWeight: 3, strokeColor: '#34d399', fillColor: '#10b981', fillOpacity: .9 }
      });

      const guessMarkerResult = new google.maps.Marker({
        position: currentGuessLatLng,
        map: resultMap,
        title: 'Your guess',
        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, strokeWeight: 3, strokeColor: '#60a5fa', fillColor: '#3b82f6', fillOpacity: .9 }
      });

      if (linkLine){ linkLine.setMap(null); }
      linkLine = new google.maps.Polyline({
        map: resultMap,
        path: [currentGuessLatLng, currentActualLatLng],
        geodesic: true,
        strokeWeight: 3,
        strokeOpacity: .9,
        strokeColor: '#7dd3fc'
      });

      const bounds = new google.maps.LatLngBounds();
      bounds.extend(currentGuessLatLng); bounds.extend(currentActualLatLng);
      resultMap.fitBounds(bounds, 80);
      document.getElementById('result').style.display = 'block';
    }

    function handleGuess(){
      if (!currentActualLatLng || !currentGuessLatLng) return;
      const km = haversineKm(currentGuessLatLng, currentActualLatLng);
      const pts = scoreFromDistanceKm(km);
      totalScore += pts;

      document.getElementById('distanceText').textContent = `${km.toFixed(1)} km away`;
      document.getElementById('scoreThisRound').textContent = pts.toString();
      document.getElementById('roundSummary').textContent = `Round ${roundNow} of ${roundMax} ¬∑ Total ${totalScore} pts`;
      document.getElementById('totalScore').textContent = totalScore.toString();
      revealResult();
    }

    function endOrNext(){
      document.getElementById('result').style.display = 'none';
      if (roundNow >= roundMax){
        setStatus('Game over! Start a new game?');
        document.getElementById('btnNew').style.display = 'inline-block';
        document.getElementById('btnGuess').disabled = true;

        // === Leaderboard save flow via modal ===
        setTimeout(async () => {
          try{
            await refreshLeaderboard();
            try{
              const name = await askForInitials();
              try{ await saveScore(name, totalScore); } catch(e){ console.error("Save failed:", e); }
              await refreshLeaderboard(name);
            }catch(err){
              // cancelled; do nothing
            }
          }catch(e){ console.error(e); }
        }, 50);

      } else {
        roundNow++;
        document.getElementById('roundNow').textContent = roundNow.toString();
        prepareNextRound();
      }
    }

    function newGame(){
      totalScore = 0;
      roundNow = 1;
      document.getElementById('roundNow').textContent = '1';
      document.getElementById('totalScore').textContent = '0';
      document.getElementById('btnNew').style.display = 'none';
      prepareNextRound();
    }

    /* ======= Toggle mini map ======= */
    function setMiniMapVisible(visible){
      const wrap = document.getElementById('globeWrap');
      const btn = document.getElementById('toggleMapBtn');
      miniMapVisible = visible;
      if (visible){
        wrap.style.display = 'block';
        document.body.classList.remove('mapHidden');
        btn.textContent = 'Hide Map';
        btn.title = 'Hide mini map';
        btn.setAttribute('aria-pressed','false');
        setTimeout(()=> google.maps.event.trigger(guessMap, 'resize'), 50);
      } else {
        wrap.style.display = 'none';
        document.body.classList.add('mapHidden');
        btn.textContent = 'Show Map';
        btn.title = 'Show mini map';
        btn.setAttribute('aria-pressed','true');
      }
    }

    /* ======= Maps/Street View Setup ======= */
    function initMapsAndUI(){
      svService = new google.maps.StreetViewService();
      pano = new google.maps.StreetViewPanorama(document.getElementById('pano'), {
        addressControl: false,
        motionTracking: false,
        panControl: true,
        showRoadLabels: false,
        zoomControl: true,
        fullscreenControl: false,
      });
      guessMap = new google.maps.Map(document.getElementById('globe'), {
        center: {lat: 15, lng: 0},
        zoom: 2,
        minZoom: 1,
        maxZoom: 5,
        mapTypeId: 'terrain',
        disableDefaultUI: true,
        streetViewControl: false,
        gestureHandling: 'greedy',
        isFractionalZoomEnabled: true,
        backgroundColor: '#0b0f1f'
      });
      guessMap.addListener('click', (e)=>{
        currentGuessLatLng = e.latLng;
        document.getElementById('btnGuess').disabled = loadingNew || !currentGuessLatLng;
        if (!guessMarker){
          guessMarker = new google.maps.Marker({
            position: e.latLng, map: guessMap, draggable: true, title: 'Your guess'
          });
          guessMarker.addListener('dragend', (ev)=>{ currentGuessLatLng = ev.latLng; });
        } else {
          guessMarker.setMap(guessMap);
          guessMarker.setPosition(e.latLng);
        }
      });
      document.getElementById('btnGuess').addEventListener('click', handleGuess);
      document.getElementById('btnSkip').addEventListener('click', ()=>{
        setStatus('Skipping‚Ä¶ finding a new place near a port.');
        prepareNextRound();
      });
      document.getElementById('btnNext').addEventListener('click', endOrNext);
      document.getElementById('btnNew').addEventListener('click', newGame);
      document.getElementById('toggleMapBtn').addEventListener('click', ()=>{
        setMiniMapVisible(!miniMapVisible);
      });

      initInitialsUI();
      prepareNextRound();
      refreshLeaderboard();
    }

    window.initGame = function(){
      document.getElementById('roundMax').textContent = String(roundMax);
      initMapsAndUI();
    };
  </script>
</body>
</html>
