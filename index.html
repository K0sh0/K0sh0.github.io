<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Street View Globe Guessing Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1220;
      --panel:#151935;
      --accent:#7dd3fc;
      --text:#e5e7eb;
      --muted:#9aa3b2;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --glass:rgba(21,25,53,.7);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 70% 20%,#1a2045 0%,#0b0e1a 60%,#070913 100%);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #app{position:relative;height:100%;width:100%}
    #pano{position:absolute;inset:0;border:none}
    /* HUD */
    .hud{
      position:absolute;left:16px;top:16px;z-index:5;
      display:flex;gap:10px;align-items:center;
      background:var(--glass);backdrop-filter: blur(8px);
      border:1px solid rgba(125,211,252,.25);
      border-radius:16px;padding:10px 14px;box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    .chip{display:flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#0f1330;border:1px solid rgba(255,255,255,.08);color:var(--text);font-weight:600;font-size:14px}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.green{background:var(--good)} .dot.yellow{background:var(--warn)}
    .chip .label{opacity:.8;font-weight:500}
    /* Globe map (mini) */
    #globeWrap{
      position:absolute;right:16px;bottom:16px;z-index:6;
      width:360px;height:260px;border-radius:18px;overflow:hidden;
      box-shadow:0 14px 40px rgba(0,0,0,.5);border:1px solid rgba(125,211,252,.25);
      background:var(--panel)
    }
    #globe{width:100%;height:100%}
    #globeHeader{
      position:absolute;left:10px;top:10px;z-index:7;
      padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.45);color:#cfe9ff;border:1px solid rgba(255,255,255,.08);font-size:12px
    }
    /* Controls */
    .controls{
      position:absolute;left:50%;transform:translateX(-50%);
      bottom:16px;z-index:7;display:flex;gap:10px;align-items:center;
      background:var(--glass);backdrop-filter: blur(10px);
      border:1px solid rgba(125,211,252,.25);border-radius:16px;padding:10px 12px;
      box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    button{
      appearance:none;border:none;cursor:pointer;
      padding:10px 14px;border-radius:10px;font-weight:700;
      color:#0b1020;background:var(--accent);transition:.2s transform, .2s opacity
    }
    button:hover{transform:translateY(-1px)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .hint{font-size:13px;color:var(--muted);padding:0 8px}
    /* Result overlay */
    #result{
      position:absolute;inset:0;z-index:8;display:none;
      background:rgba(3,6,18,.65);backdrop-filter:blur(6px)
    }
    #resultCard{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:min(92vw,960px);height:min(80vh,580px);background:var(--panel);
      border:1px solid rgba(125,211,252,.25);border-radius:18px;overflow:hidden;
      box-shadow:0 30px 80px rgba(0,0,0,.6)
    }
    #resultMap{width:100%;height:70%}
    #resultInfo{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 16px;border-top:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(17,23,50,.85),rgba(17,23,50,.65))
    }
    .scoreLine{display:flex;gap:14px;align-items:baseline}
    .scoreBig{font-size:28px;font-weight:900}
    .distance{font-size:14px;color:#cfe9ff;opacity:.9}
    .rounds{font-size:12px;color:var(--muted)}
    .pill{padding:6px 10px;border-radius:999px;background:#0f1330;border:1px solid rgba(255,255,255,.08);color:#bfe7ff;font-weight:600}
    .secondary{background:#22274f;color:#e5e7eb;border:1px solid rgba(255,255,255,.08)}
    .footerHelp{
      position:absolute;right:16px;top:16px;z-index:5;font-size:12px;color:#b9c3d6;opacity:.9
    }
    @media (max-width:720px){
      #globeWrap{width:75vw;height:38vh}
      .controls{left:auto;right:16px;transform:none}
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="pano"></div>

    <div class="hud" id="hud">
      <div class="chip"><span class="dot green"></span><span class="label">Round</span> <span id="roundNow">1</span>/ <span id="roundMax">5</span></div>
      <div class="chip"><span class="dot yellow"></span><span class="label">Total</span> <span id="totalScore">0</span> pts</div>
    </div>

    <div id="globeWrap">
      <div id="globeHeader">Click the globe to place your guess</div>
      <div id="globe"></div>
    </div>

    <div class="footerHelp">Tip: You can move around in Street View before guessing.</div>

    <div class="controls">
      <span class="hint" id="status">Loading a random location…</span>
      <button id="btnGuess" disabled>Guess</button>
      <button id="btnSkip" class="secondary">Skip</button>
      <button id="btnNew" class="secondary" style="display:none">New Game</button>
    </div>

    <!-- Result overlay -->
    <div id="result">
      <div id="resultCard">
        <div id="resultMap"></div>
        <div id="resultInfo">
          <div class="scoreLine">
            <span class="pill" id="distanceText">—</span>
            <span class="scoreBig" id="scoreThisRound">0</span><span>pts</span>
            <span class="rounds" id="roundSummary"></span>
          </div>
          <div>
            <button id="btnNext">Next Round</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Google Maps JS (Street View + Maps). Your API key is embedded per your request. -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAIujmdEMh04_ZfJB1kZ0839Fh_MI8pQAU&v=weekly&callback=initGame">
  </script>

  <script>
    /* ======= Game State ======= */
    let pano, svService, guessMap, resultMap, guessMarker, actualMarker, linkLine;
    let currentActualLatLng = null;
    let currentGuessLatLng = null;
    let totalScore = 0;
    let roundNow = 1;
    const roundMax = 5;
    let loadingNew = false;

    /* ======= Utilities ======= */
    function rand(min, max){ return Math.random()*(max-min)+min; }

    // Random lat/lng with light bias to populated latitudes, avoids extreme poles & oceans a bit
    function randomLatLng() {
      // Latitude: pick from a distribution favoring mid-latitudes
      const bands = [
        {min:-60, max:-30, w:1}, {min:-30, max:0, w:2.5},
        {min:0, max:30, w:3}, {min:30, max:55, w:2.5}, {min:55, max:70, w:1}
      ];
      const sumW = bands.reduce((s,b)=>s+b.w,0);
      let r = Math.random()*sumW, pick=bands[0];
      for (const b of bands){ if ((r-=b.w) <= 0){ pick=b; break; } }
      const lat = rand(pick.min, pick.max);
      const lng = rand(-180, 180);
      return new google.maps.LatLng(lat, lng);
    }

    function haversineKm(a, b){
      const R = 6371; // km
      const toRad = (d)=>d*Math.PI/180;
      const dLat = toRad(b.lat()-a.lat());
      const dLng = toRad(b.lng()-a.lng());
      const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
      const A = s1*s1 + Math.cos(toRad(a.lat()))*Math.cos(toRad(b.lat()))*s2*s2;
      const c = 2*Math.atan2(Math.sqrt(A), Math.sqrt(1-A));
      return R*c;
    }

    // Score similar feel to GeoGuessr: decays with distance
    function scoreFromDistanceKm(d){
      const s = 5000*Math.exp(-d/2000); // 2,000 km characteristic decay
      return Math.max(0, Math.round(s));
    }

    function setStatus(txt){ document.getElementById('status').textContent = txt; }

    /* ======= Core Flow ======= */
    async function loadRandomPano(maxTries=25){
      loadingNew = true;
      setStatus('Finding a Street View spot…');
      return new Promise((resolve, reject)=>{
        let tries = 0;
        (function attempt(){
          if (tries++ >= maxTries){ reject(new Error('No panorama found.')); return; }
          const loc = randomLatLng();
          svService.getPanorama(
            { location: loc, radius: 50000, preference: google.maps.StreetViewPreference.BEST, source: google.maps.StreetViewSource.OUTDOOR },
            (data, status)=>{
              if (status === google.maps.StreetViewStatus.OK && data && data.location && data.location.latLng){
                resolve(data);
              } else {
                setStatus(`Searching… (try ${tries}/${maxTries})`);
                setTimeout(attempt, 60);
              }
            }
          );
        })();
      });
    }

    function showPanorama(panoData){
      const latLng = panoData.location.latLng;
      currentActualLatLng = latLng;
      pano.setPano(panoData.location.pano);
      pano.setPov({heading: 0, pitch: 0});
      pano.setVisible(true);
      // Enable movement/navigation by default
      pano.setOptions({ linksControl: true, panControl: true, zoomControl: true, motionTracking: false });
      setStatus('Explore, then click the globe to place your guess.');
      document.getElementById('btnGuess').disabled = !currentGuessLatLng;
      loadingNew = false;
    }

    function prepareNextRound(){
      // Clear guess marker & state
      if (guessMarker){ guessMarker.setMap(null); guessMarker = null; }
      if (actualMarker){ actualMarker.setMap(null); actualMarker = null; }
      if (linkLine){ linkLine.setMap(null); linkLine = null; }
      currentGuessLatLng = null;
      document.getElementById('btnGuess').disabled = true;
      setStatus('Loading a random location…');
      loadRandomPano().then(showPanorama).catch(()=>{
        setStatus('Could not find a Street View right now. Try again.');
      });
    }

    function revealResult(){
      // Build results map with guess + actual + line
      if (!resultMap){
        resultMap = new google.maps.Map(document.getElementById('resultMap'), {
          zoom: 3,
          center: currentActualLatLng,
          mapTypeId: 'terrain',
          gestureHandling: 'greedy',
          disableDefaultUI: false
        });
      }
      // Clear existing overlays
      if (actualMarker){ actualMarker.setMap(null); }
      if (guessMarker && guessMarker.getMap() === resultMap){ guessMarker.setMap(null); }

      actualMarker = new google.maps.Marker({
        position: currentActualLatLng,
        map: resultMap,
        title: 'Actual location',
        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, strokeWeight: 3, strokeColor: '#34d399', fillColor: '#10b981', fillOpacity: .9 }
      });

      const guessMarkerResult = new google.maps.Marker({
        position: currentGuessLatLng,
        map: resultMap,
        title: 'Your guess',
        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, strokeWeight: 3, strokeColor: '#60a5fa', fillColor: '#3b82f6', fillOpacity: .9 }
      });

      // Line between points
      if (linkLine){ linkLine.setMap(null); }
      linkLine = new google.maps.Polyline({
        map: resultMap,
        path: [currentGuessLatLng, currentActualLatLng],
        geodesic: true,
        strokeWeight: 3,
        strokeOpacity: .9,
        strokeColor: '#7dd3fc'
      });

      // Fit bounds
      const bounds = new google.maps.LatLngBounds();
      bounds.extend(currentGuessLatLng); bounds.extend(currentActualLatLng);
      resultMap.fitBounds(bounds, 80);

      // Show overlay
      document.getElementById('result').style.display = 'block';
    }

    function handleGuess(){
      if (!currentActualLatLng || !currentGuessLatLng) return;
      const km = haversineKm(currentGuessLatLng, currentActualLatLng);
      const pts = scoreFromDistanceKm(km);
      totalScore += pts;

      // UI text
      document.getElementById('distanceText').textContent = `${km.toFixed(1)} km away`;
      document.getElementById('scoreThisRound').textContent = pts.toString();
      document.getElementById('roundSummary').textContent = `Round ${roundNow} of ${roundMax} · Total ${totalScore} pts`;
      document.getElementById('totalScore').textContent = totalScore.toString();

      // Show both points on the result overlay map
      revealResult();
    }

    function endOrNext(){
      document.getElementById('result').style.display = 'none';
      if (roundNow >= roundMax){
        setStatus('Game over! Start a new game?');
        document.getElementById('btnNew').style.display = 'inline-block';
        document.getElementById('btnGuess').disabled = true;
      } else {
        roundNow++;
        document.getElementById('roundNow').textContent = roundNow.toString();
        prepareNextRound();
      }
    }

    function newGame(){
      totalScore = 0;
      roundNow = 1;
      document.getElementById('roundNow').textContent = '1';
      document.getElementById('totalScore').textContent = '0';
      document.getElementById('btnNew').style.display = 'none';
      prepareNextRound();
    }

    /* ======= Maps/Street View Setup ======= */
    function initMapsAndUI(){
      svService = new google.maps.StreetViewService();

      pano = new google.maps.StreetViewPanorama(document.getElementById('pano'), {
        addressControl: false,
        motionTracking: false,
        panControl: true,
        showRoadLabels: false,
        zoomControl: true,
        fullscreenControl: false,
      });

      // Mini "globe" map (vector maps show a 3D globe when zoomed out)
      guessMap = new google.maps.Map(document.getElementById('globe'), {
        center: {lat: 15, lng: 0},
        zoom: 2,
        minZoom: 1,
        maxZoom: 5,
        mapTypeId: 'terrain',
        disableDefaultUI: true,
        streetViewControl: false,
        gestureHandling: 'greedy',
        isFractionalZoomEnabled: true,
        backgroundColor: '#0b0f1f'
      });

      // Clicking the mini-map places/updates the guess
      guessMap.addListener('click', (e)=>{
        currentGuessLatLng = e.latLng;
        document.getElementById('btnGuess').disabled = loadingNew || !currentGuessLatLng;
        // Place or move marker on the mini map
        if (!guessMarker){
          guessMarker = new google.maps.Marker({
            position: e.latLng,
            map: guessMap,
            draggable: true,
            title: 'Your guess'
          });
          guessMarker.addListener('dragend', (ev)=>{ currentGuessLatLng = ev.latLng; });
        } else {
          guessMarker.setMap(guessMap);
          guessMarker.setPosition(e.latLng);
        }
      });

      // Buttons
      document.getElementById('btnGuess').addEventListener('click', handleGuess);
      document.getElementById('btnSkip').addEventListener('click', ()=>{
        setStatus('Skipping… finding a new place.');
        prepareNextRound();
      });
      document.getElementById('btnNext').addEventListener('click', endOrNext);
      document.getElementById('btnNew').addEventListener('click', newGame);

      // First load
      prepareNextRound();
    }

    /* ======= Global init callback for Google Maps loader ======= */
    window.initGame = function(){
      initMapsAndUI();
    };
  </script>
</body>
</html>
